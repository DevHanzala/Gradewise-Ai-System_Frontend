import{h as re,u as ae,ab as oe,r as i,j as e,L as y,N as B,C as j,b as N,g as T,M,s as P,P as U}from"./index-BE97Blc-.js";import{u as ne}from"./assessmentStore-CWi3OlGP.js";import{u as ie}from"./resourceStore-CzSNu-NW.js";import{l as le}from"./index-CA1CrNgP.js";function pe(){const{id:u}=re(),d=ae(),q=oe(),{currentAssessment:a,loading:v,error:C,getAssessmentById:A,updateAssessment:Q}=ne(),{resources:L,fetchAllResources:E,loading:z}=ie(),[l,c]=i.useState({isOpen:!1,type:"info",title:"",message:""}),[n,m]=i.useState({title:"",prompt:"",externalLinks:[""]}),[p,b]=i.useState([{question_type:"multiple_choice",question_count:1,duration_per_question:120,num_options:4,positive_marks:1,negative_marks:0}]),[_,S]=i.useState([]),[g,$]=i.useState([]),[F,D]=i.useState(0),[J,I]=i.useState(""),[h,O]=i.useState(!1),[G,w]=i.useState(!1),k=i.useRef(null);i.useEffect(()=>{(async()=>{try{if(!u||isNaN(parseInt(u))){console.warn(`âš ï¸ Invalid assessment ID: "${u}" at ${q.pathname}`),c({isOpen:!0,type:"error",title:"Invalid Assessment",message:"The assessment ID is invalid. Redirecting to assessments list."}),U.error("Invalid assessment ID"),d("/instructor/assessments");return}await E(),await A(parseInt(u))}catch(r){console.error("âŒ Error fetching assessment or resources:",r);const t=r.response?.data?.message||r.message||"Failed to fetch assessment or resources";c({isOpen:!0,type:"error",title:"Error",message:t}),U.error(t),r.response?.status===403||r.message==="No authentication token found"?setTimeout(()=>d("/login"),2e3):(r.response?.status===404||r.message==="Invalid assessment ID")&&d("/instructor/assessments")}})()},[u,A,E,d,q.pathname]),i.useEffect(()=>{a&&(m({title:a.title||"",prompt:a.prompt||"",externalLinks:Array.isArray(a.external_links)?a.external_links:[""]}),b(Array.isArray(a.question_blocks)&&a.question_blocks.length>0?a.question_blocks.map(s=>({question_type:s.question_type||"multiple_choice",question_count:Number(s.question_count)||1,duration_per_question:Number(s.duration_per_question)||120,num_options:Number(s.num_options)||4,positive_marks:Number(s.positive_marks)||1,negative_marks:Number(s.negative_marks)||0})):[{question_type:"multiple_choice",question_count:1,duration_per_question:120,num_options:4,positive_marks:1,negative_marks:0}]),S(Array.isArray(a.resources)?a.resources.map(s=>s.id).filter(s=>s&&!isNaN(s)):[]))},[a]),i.useEffect(()=>{const r=le("https://gradeadmin.techmiresolutions.com/api",{transports:["websocket"],withCredentials:!0});return k.current=r,r.on("assessment-progress",t=>{D(t.percent),I(t.message)}),()=>r.disconnect()},[]);const R=s=>{const{name:r,value:t}=s.target;m(o=>({...o,[r]:t}))},x=(s,r,t)=>{w(!0),b(o=>o.map((f,te)=>te===s?{...f,[r]:r==="question_count"||r==="duration_per_question"||r==="num_options"?Math.max(Number.parseInt(t)||1,1):r==="positive_marks"||r==="negative_marks"?t===""||t===null?null:Math.max(Number.parseFloat(t)||0,0):t}:f))},H=()=>{w(!0),b(s=>[...s,{question_type:"multiple_choice",question_count:1,duration_per_question:120,num_options:4,positive_marks:1,negative_marks:0}])},V=s=>{w(!0),p.length>1&&b(r=>r.filter((t,o)=>o!==s))},Y=()=>{m(s=>({...s,externalLinks:[...s.externalLinks,""]}))},K=s=>{m(r=>({...r,externalLinks:r.externalLinks.filter((t,o)=>o!==s)}))},W=(s,r)=>{m(t=>({...t,externalLinks:t.externalLinks.map((o,f)=>f===s?r:o)}))},X=s=>{$([...s.target.files])},Z=s=>{S(r=>r.includes(s)?r.filter(t=>t!==s):[...r,s])},ee=()=>{if(!n.title||!n.title.trim())return"Assessment Title is required";const s=_.length>0||g.length>0,r=n.externalLinks.some(t=>t&&t.trim());if(!n.prompt?.trim()&&!s&&!r)return"You must provide either a Prompt, Resources, or External Links";for(const t of p){if(!t.question_count||t.question_count<1)return"Question count must be at least 1";if(!t.duration_per_question||t.duration_per_question<30)return"Duration per question must be at least 30 seconds";if(t.question_type==="multiple_choice"&&(!t.num_options||t.num_options<2))return"Multiple choice needs at least 2 options"}return null},se=async s=>{s.preventDefault();const r=ee();if(r){c({isOpen:!0,type:"error",title:"Validation Error",message:r});return}O(!0),D(0),I("Updating...");const t=new FormData;console.log("DEBUG: Frontend EditAssessment - Title before append:",n.title,"Trimmed:",n.title.trim()),t.append("title",n.title.trim()),n.prompt?.trim()&&t.append("prompt",n.prompt.trim()),t.append("externalLinks",JSON.stringify(n.externalLinks.filter(o=>o.trim()))),G&&t.append("question_blocks",JSON.stringify(p.map(o=>({question_type:o.question_type,question_count:o.question_count,duration_per_question:o.duration_per_question,num_options:o.question_type==="multiple_choice"?o.num_options:null,positive_marks:o.positive_marks||1,negative_marks:o.negative_marks||0})))),t.append("selected_resources",JSON.stringify(_)),g.forEach(o=>t.append("new_files",o)),k.current?.id&&t.append("socketId",k.current.id);try{await Q(parseInt(u),t),c({isOpen:!0,type:"success",title:"Success!",message:"Assessment updated!"}),setTimeout(()=>d("/instructor/assessments"),1500)}catch(o){console.error("DEBUG: Frontend EditAssessment - Update error:",o),c({isOpen:!0,type:"error",title:"Error",message:o.message||"Update failed"})}finally{O(!1)}};return v||!a?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 flex flex-col justify-center items-center",children:[e.jsx(y,{size:"lg",type:"spinner",color:"blue"}),e.jsx("span",{className:"mt-4 text-gray-600 font-medium",children:"Loading assessment details..."})]}):C?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50",children:[e.jsx(B,{}),e.jsx("div",{className:"max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-16",children:e.jsx(j,{className:"shadow-lg border-0",children:e.jsx(N,{className:"p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-7xl mb-6",children:"âš ï¸"}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:"Error"}),e.jsx("p",{className:"text-gray-600 mb-8",children:C}),e.jsx("button",{onClick:()=>d("/instructor/assessments"),className:"px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all duration-200 font-semibold shadow-md hover:shadow-lg",children:"â† Back to Assessments"})]})})})}),e.jsx(T,{}),e.jsx(M,{isOpen:l.isOpen,onClose:()=>c({...l,isOpen:!1}),type:l.type,title:l.title,children:l.message})]}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50",children:[e.jsx(B,{}),e.jsxs("div",{className:"max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"flex items-center gap-2 mb-4",children:e.jsx("button",{onClick:()=>d("/instructor/assessments"),className:"text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1 transition-colors duration-200",children:"â† Back"})}),e.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-gray-900 mb-2",children:"Edit Assessment"}),e.jsx("p",{className:"text-gray-600",children:"Update your assessment details and configuration"}),a.is_executed&&e.jsxs("div",{className:"mt-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 flex items-start gap-3",children:[e.jsx("span",{className:"text-2xl",children:"âš ï¸"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-yellow-900",children:"Assessment Executed"}),e.jsx("p",{className:"text-sm text-yellow-800",children:"This assessment has been executed and cannot be modified."})]})]})]}),h&&e.jsx(j,{className:"mb-6 border-blue-300 bg-gradient-to-r from-blue-50 to-indigo-50 shadow-lg",children:e.jsxs(N,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"}),e.jsx("p",{className:"text-sm font-medium text-blue-900",children:J})]}),e.jsxs("p",{className:"text-lg font-bold text-blue-900",children:[Math.round(F),"%"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-3 overflow-hidden shadow-inner",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-indigo-600 h-3 rounded-full transition-all duration-500 ease-out shadow-sm",style:{width:`${F}%`}})})]})}),e.jsxs("form",{onSubmit:se,className:"space-y-6",children:[e.jsxs(j,{className:"shadow-md hover:shadow-lg transition-shadow duration-300 border-0",children:[e.jsx(P,{className:"bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-t-lg",children:e.jsx("h2",{className:"text-xl font-semibold",children:"ðŸ“ Assessment Details"})}),e.jsx(N,{className:"p-6 sm:p-8",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"title",className:"block text-sm font-semibold text-gray-700 mb-2",children:["Assessment Title ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",name:"title",id:"title",value:n.title,onChange:R,className:"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-gray-300 disabled:bg-gray-100 disabled:cursor-not-allowed",placeholder:"e.g., Data Structures Final Exam",disabled:a.is_executed})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"prompt",className:"block text-sm font-semibold text-gray-700 mb-2",children:["AI Prompt ",e.jsx("span",{className:"text-gray-500 font-normal",children:"(Optional if using resources or links)"})]}),e.jsx("textarea",{name:"prompt",id:"prompt",value:n.prompt,onChange:R,rows:5,className:"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-gray-300 resize-none disabled:bg-gray-100 disabled:cursor-not-allowed",placeholder:"Provide a detailed prompt for question generation...",disabled:a.is_executed})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6 border-2 border-gray-100",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-4",children:"ðŸ”— External Links"}),e.jsx("div",{className:"space-y-3",children:n.externalLinks.map((s,r)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"url",value:s,onChange:t=>W(r,t.target.value),placeholder:"https://example.com/resource",className:"flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-gray-300 disabled:bg-gray-100 disabled:cursor-not-allowed",disabled:a.is_executed}),n.externalLinks.length>1&&e.jsx("button",{type:"button",onClick:()=>K(r),className:"px-4 py-3 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed",disabled:a.is_executed,children:"Remove"})]},r))}),e.jsx("button",{type:"button",onClick:Y,className:"mt-4 px-5 py-2.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed",disabled:a.is_executed,children:"+ Add Link"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6 border-2 border-gray-100",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-4",children:"ðŸ“š Resources"}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"new_files",className:"block text-sm font-medium text-gray-700 mb-2",children:"Upload New Files"}),e.jsx("div",{className:"relative",children:e.jsx("input",{type:"file",id:"new_files",multiple:!0,accept:".pdf,.doc,.docx,.txt,.ppt,.pptx,.jpg,.jpeg,.png,.webp",onChange:X,className:"w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-blue-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 disabled:opacity-50 disabled:cursor-not-allowed",disabled:a.is_executed})}),g.length>0&&e.jsxs("div",{className:"mt-3 bg-white rounded-lg p-3 border border-gray-200",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-600 mb-2",children:"Selected Files:"}),e.jsx("ul",{className:"space-y-1",children:g.map((s,r)=>e.jsxs("li",{className:"text-sm text-gray-700 flex items-center gap-2",children:[e.jsx("span",{className:"text-blue-600",children:"ðŸ“„"}),s.name]},r))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Existing Resources"}),z?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(y,{size:"sm",type:"dots",color:"blue"})}):L.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto border-2 border-gray-200 rounded-lg p-4 bg-white",children:L.map(s=>e.jsxs("div",{className:"flex items-center p-2 hover:bg-gray-50 rounded-md transition-colors duration-150",children:[e.jsx("input",{type:"checkbox",id:`resource-${s.id}`,checked:_.includes(s.id),onChange:()=>Z(s.id),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",disabled:a.is_executed}),e.jsxs("label",{htmlFor:`resource-${s.id}`,className:"ml-3 text-sm text-gray-700 cursor-pointer flex-1",children:[e.jsx("span",{className:"font-medium",children:s.name}),e.jsxs("span",{className:"text-gray-500 ml-2",children:["(",s.content_type,")"]})]})]},s.id))}):e.jsx("div",{className:"text-center py-8 bg-white border-2 border-dashed border-gray-200 rounded-lg",children:e.jsx("p",{className:"text-gray-500",children:"No resources available"})})]})]})]})]})})]}),e.jsxs(j,{className:"shadow-md hover:shadow-lg transition-shadow duration-300 border-0",children:[e.jsx(P,{className:"bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-t-lg",children:e.jsx("h2",{className:"text-xl font-semibold",children:"â“ Question Configuration"})}),e.jsx(N,{className:"p-6 sm:p-8",children:e.jsxs("div",{className:"space-y-6",children:[p.map((s,r)=>e.jsxs("div",{className:"p-6 border-2 border-gray-200 rounded-xl bg-gradient-to-br from-white to-gray-50 hover:border-blue-300 transition-all duration-300",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:e.jsxs("span",{className:"bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm",children:["Block ",r+1]})}),p.length>1&&e.jsx("button",{type:"button",onClick:()=>V(r),className:"text-red-600 hover:text-red-800 font-medium hover:bg-red-50 px-3 py-1 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",disabled:a.is_executed,children:"ðŸ—‘ï¸ Remove"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Question Type"}),e.jsxs("select",{value:s.question_type,onChange:t=>x(r,"question_type",t.target.value),className:"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-gray-300 bg-white disabled:bg-gray-100 disabled:cursor-not-allowed",disabled:a.is_executed,children:[e.jsx("option",{value:"multiple_choice",children:"Multiple Choice"}),e.jsx("option",{value:"short_answer",children:"Short Answer"}),e.jsx("option",{value:"true_false",children:"True/False"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Question Count"}),e.jsx("input",{type:"number",value:s.question_count,onChange:t=>x(r,"question_count",t.target.value),min:"1",placeholder:"e.g. 5",className:"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-gray-300 disabled:bg-gray-100 disabled:cursor-not-allowed",disabled:a.is_executed})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Duration (seconds)"}),e.jsx("input",{type:"number",value:s.duration_per_question,onChange:t=>x(r,"duration_per_question",t.target.value),min:"30",placeholder:"e.g. 120",className:"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-gray-300 disabled:bg-gray-100 disabled:cursor-not-allowed",disabled:a.is_executed})]}),s.question_type==="multiple_choice"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Number of Options"}),e.jsx("input",{type:"number",value:s.num_options,onChange:t=>x(r,"num_options",t.target.value),min:"2",max:"6",placeholder:"2 to 6",className:"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-gray-300 disabled:bg-gray-100 disabled:cursor-not-allowed",disabled:a.is_executed})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Negative Marks"}),e.jsx("input",{type:"number",value:s.negative_marks||"",onChange:t=>x(r,"negative_marks",t.target.value),min:"0",step:"0.1",placeholder:"e.g. 0.25",className:"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 hover:border-gray-300 disabled:bg-gray-100 disabled:cursor-not-allowed",disabled:a.is_executed})]})]})]},r)),e.jsx("button",{type:"button",onClick:H,className:"w-full py-3 bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-600 rounded-lg hover:from-blue-100 hover:to-indigo-100 transition-all duration-200 font-semibold border-2 border-dashed border-blue-300 hover:border-blue-400 disabled:opacity-50 disabled:cursor-not-allowed",disabled:a.is_executed,children:"+ Add Question Block"})]})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>d("/instructor/assessments"),className:"px-8 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-200 font-medium order-2 sm:order-1 disabled:opacity-50 disabled:cursor-not-allowed",disabled:h,children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center font-semibold shadow-md hover:shadow-lg order-1 sm:order-2",disabled:v||h||a.is_executed,children:h?e.jsxs(e.Fragment,{children:[e.jsx(y,{size:"sm",color:"white",type:"gradient"}),e.jsx("span",{className:"ml-2",children:"Processing..."})]}):v?e.jsxs(e.Fragment,{children:[e.jsx(y,{size:"sm",color:"white",type:"gradient"}),e.jsx("span",{className:"ml-2",children:"Updating..."})]}):e.jsx(e.Fragment,{children:e.jsx("span",{children:"âœ¨ Update Assessment"})})})]})]})]}),e.jsx(T,{}),e.jsx(M,{isOpen:l.isOpen,onClose:()=>c({...l,isOpen:!1}),type:l.type,title:l.title,children:l.message})]})}export{pe as default};
